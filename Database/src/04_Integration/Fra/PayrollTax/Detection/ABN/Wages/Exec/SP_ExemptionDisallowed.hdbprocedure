PROCEDURE "osr.edw.platform.fra.prt.dt.abn.wages.ex::SP_ExemptionDisallowed"( 
	IN  it_data_for_rule 	"osr.edw.platform.fra.prt.dt.abn::Types.wages.ws",
    OUT et_result       	"osr.edw.platform.fra.prt.dt.abn::Types.wages.result",
    OUT et_text             "osr.edw.platform.fra.prt.dt.abn::Types.wages.text"
)
   
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER
READS SQL DATA AS

BEGIN

lt_exm_priority =
SELECT
"DO"."ABN",
"DO"."PERIOD_CATEGORY",
"DO"."PERIOD_KEY",
"DO"."GJAHR",
"CASE"."CASE_ID",
"CASE"."PARTNER",
"CASE"."REASON_CODE" 
FROM
        (
    		SELECT "ABN", "CASE_ID", "PARTNER", "REASON_CODE" FROM     
					(              
							SELECT "ABN",
									"CASE_ID",
									"PARTNER",
									"REASON_CODE", 
									RANK() OVER (PARTITION BY "ABN", "PARTNER" ORDER BY "ABN", "PARTNER" DESC, "CASE_ID" DESC) AS "RANK_1" 
							FROM   "osr.edw.platform.fra.prt.dt.abn::CV_CRM_BP_CASE" 
							WHERE "CASE_TYPE" = 'ZEXM'
							AND "REASON_CODE" <> 'INVD'

					)
			WHERE "RANK_1" = 1) AS "CASE" 
INNER JOIN 
:it_data_for_rule AS "DO"
ON "CASE"."ABN" = "DO"."ABN"
;

et_result = 
SELECT
"ABN",
"PERIOD_CATEGORY",
"PERIOD_KEY",
"GJAHR",
CASE
WHEN ("REASON_CODE") = 'DISA'
THEN 100
ELSE 0
END AS "DETECTION_RESULT"
FROM
:lt_exm_priority
;

et_text = 
SELECT 
"ABN",
"PERIOD_CATEGORY",
"PERIOD_KEY",
"GJAHR",
'' AS "TEXT",
'/OSRQLD/FRA_PRT' AS "MSGID",
CASE WHEN "REASON_CODE" = 'DISA'
THEN '009'
ELSE '010'
END AS "MSGNO",
LTRIM("CASE_ID") AS "MSGV1",
LTRIM("PARTNER") AS "MSGV2",
'' AS "MSGV3",
'' AS "MSGV4",
'' AS "MSGV1_FC",
'' AS "MSGV2_FC",
'' AS "MSGV3_FC",
'' AS "MSGV4_FC"
FROM 
:lt_exm_priority
;

END
