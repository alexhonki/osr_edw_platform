PROCEDURE "osr.edw.platform.fra.prt.model::SP_GRP_GRAPH_GET_VERTEX_N_EDGE_TEST"(
	IN  IV_GRP_DATE        DATE,
	IN	IV_MATCH_PERSON	   NVARCHAR(1),
	OUT ET_ELEMENT         "osr.edw.platform.fra.prt.model::Types.DisjointElementT",
	OUT ET_ELEMENT_REL	   "osr.edw.platform.fra.prt.model::Types.DisjointElementRelT"
)
   LANGUAGE SQLSCRIPT
   SQL SECURITY INVOKER
   READS SQL DATA AS
BEGIN

DECLARE LV_ORG_PREFIX	NVARCHAR(1); 
DECLARE LV_PSN_PREFIX	NVARCHAR(1);
DECLARE LV_PGP_PREFIX	NVARCHAR(1);

-- Added for trust 
DECLARE LV_TRUST_PREFIX	NVARCHAR(1);
DECLARE LV_BNFCRY_PREFIX	NVARCHAR(1);


LV_ORG_PREFIX := '0';
LV_PSN_PREFIX := '1'; 
LV_PGP_PREFIX := '2';

-- Added for trust 
LV_TRUST_PREFIX := '3';
LV_BNFCRY_PREFIX := '4';


LT_SH = 
SELECT
'000000011' AS "ORG_NUMBER",
'O000000010' AS "PARENT_ID",
'O000000011' AS "CHILD_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'000000012'AS "ORG_NUMBER",
'O000000010' AS "PARENT_ID",
'O000000012' AS "CHILD_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'000000010' AS "ORG_NUMBER",
'O000000020' AS "PARENT_ID",
'O000000010' AS "CHILD_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION 
SELECT
'000000020' AS "ORG_NUMBER",
'P000000001' AS "PARENT_ID",
'O000000020' AS "CHILD_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
;

LT_DR = 
SELECT
'000000031' AS "ORG_NUMBER",
'000000002' AS "PERSON_NUM",
'O000000031' AS "CHILD_ID",
'P000000002' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'000000032' AS "ORG_NUMBER",
'000000002' AS "PERSON_NUM",
'O000000032' AS "CHILD_ID",
'P000000002' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'000000032' AS "ORG_NUMBER",
'000000003' AS "PERSON_NUMBER",
'O000000032' AS "CHILD_ID",
'P000000003' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
;

LT_PG = 
SELECT
'P000000002' AS "ID",
'C000000001' AS "PGRP_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'P000000003' AS "ID",
'C000000001' AS "PGRP_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
;

LT_TR = 
SELECT
'34027986606' AS "TRUST_ABN",
'11005260748' AS "BNFCRY_ABN",
'B11005260748' AS "CHILD_ID",
'T34027986606' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'34027986606' AS "TRUST_ABN",
'80121017677' AS "BNFCRY_ABN",
'B80121017677' AS "CHILD_ID",
'T34027986606' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'43519940525' AS "TRUST_ABN",
'80121017677' AS "BNFCRY_ABN",
'B80121017677' AS "CHILD_ID",
'T43519940525' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'44731838095' AS "TRUST_ABN",
'11005260748' AS "BNFCRY_ABN",
'B11005260748' AS "CHILD_ID",
'T44731838095' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'44731838095' AS "TRUST_ABN",
'80121017677' AS "BNFCRY_ABN",
'B80121017677' AS "CHILD_ID",
'T44731838095' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'51906323785' AS "TRUST_ABN",
'80121017677' AS "BNFCRY_ABN",
'B80121017677' AS "CHILD_ID",
'T51906323785' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'83949919166' AS "TRUST_ABN",
'80121017677' AS "BNFCRY_ABN",
'B80121017677' AS "CHILD_ID",
'T83949919166' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'90315416448' AS "TRUST_ABN",
'80121017677' AS "BNFCRY_ABN",
'B80121017677' AS "CHILD_ID",
'T90315416448' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'92870705122' AS "TRUST_ABN",
'80121017677' AS "BNFCRY_ABN",
'B80121017677' AS "CHILD_ID",
'T92870705122' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'93090895569' AS "TRUST_ABN",
'11005260748' AS "BNFCRY_ABN",
'B11005260748' AS "CHILD_ID",
'T93090895569' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
UNION
SELECT
'93090895569' AS "TRUST_ABN",
'80121017677' AS "BNFCRY_ABN",
'B80121017677' AS "CHILD_ID",
'T93090895569' AS "PARENT_ID"
FROM "osr.hana.platform.synonym::SYS.DUMMY"
;



   LT_ELEMENT_REL = 
-- shareholding relation
   SELECT 
   TO_BIGINT(:LV_ORG_PREFIX || "ORG_NUMBER") AS "ELEMENT_L_NUM", 
   CASE WHEN LEFT("PARENT_ID",1) = 'O' THEN TO_BIGINT(:LV_ORG_PREFIX || RIGHT("PARENT_ID",9)) 
   ELSE TO_BIGINT(:LV_PSN_PREFIX || RIGHT("PARENT_ID",9)) 
   END
   AS "ELEMENT_R_NUM",
   "CHILD_ID",
   "PARENT_ID"
   FROM 
   :LT_SH
   UNION
-- director relation 
   SELECT 
    TO_BIGINT(:LV_ORG_PREFIX || "ORG_NUMBER") AS "ELEMENT_L_NUM", 
    TO_BIGINT(:LV_PSN_PREFIX || "PERSON_NUM") AS "ELEMENT_R_NUM",
    "CHILD_ID",
    "PARENT_ID"
   FROM 
   :LT_DR
     UNION
-- trust relation 
   SELECT 
    TO_BIGINT(:LV_ORG_PREFIX || "PARENT_ID") AS "ELEMENT_L_NUM", 
    TO_BIGINT(:LV_PSN_PREFIX || "CHILD_ID") AS "ELEMENT_R_NUM",
    "CHILD_ID",
    "PARENT_ID"
   FROM 
   :LT_TR
   ;
   
   IF :IV_MATCH_PERSON = 'Y' THEN
   LT_ELEMENT_REL = 
	SELECT 
   "ELEMENT_L_NUM", 
   "ELEMENT_R_NUM",
   "CHILD_ID",
   "PARENT_ID"
   FROM :LT_ELEMENT_REL
   UNION
-- person to person group relation  
   SELECT 
    TO_BIGINT(:LV_PSN_PREFIX || RIGHT("ID",9)) AS "ELEMENT_L_NUM", 
    TO_BIGINT(:LV_PGP_PREFIX || RIGHT("PGRP_ID",9)) AS "ELEMENT_R_NUM", 
    "ID" AS "CHILD_ID",
    "PGRP_ID" AS "PARENT_ID"
   FROM
	:LT_PG
	;
   END IF;
   
   ET_ELEMENT = 
   SELECT 
   DISTINCT "ELEMENT_NUM", "ELEMENT" 
   FROM (
   SELECT 
   "ELEMENT_L_NUM" AS "ELEMENT_NUM", 
   "CHILD_ID" AS "ELEMENT" FROM :LT_ELEMENT_REL
   UNION
   SELECT 
   "ELEMENT_R_NUM" AS "ELEMENT_NUM", 
   "PARENT_ID" AS "ELEMENT" FROM :LT_ELEMENT_REL
   )
   ;
   
   ET_ELEMENT_REL = 
   SELECT DISTINCT
   "ELEMENT_L_NUM", 
   "ELEMENT_R_NUM"
   FROM 
   :LT_ELEMENT_REL
   ;
   
END